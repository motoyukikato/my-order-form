<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JANå¯¾å¿œãƒ»å—æ³¨ã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; color: #333; }
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2, h3 { margin-top: 0; color: #00B900; }
        label { font-size: 0.9em; font-weight: bold; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        
        /* ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
        button { color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { opacity: 0.7; }
        .btn-scan { background: #555; } /* ã‚¹ã‚­ãƒ£ãƒ³ï¼šã‚°ãƒ¬ãƒ¼ */
        .btn-add { background: #007bff; } /* ãƒªã‚¹ãƒˆè¿½åŠ ï¼šé’ */
        .btn-send { background: #00B900; margin-top: 20px; font-size: 18px; } /* æ³¨æ–‡ç¢ºå®šï¼šLINEã‚°ãƒªãƒ¼ãƒ³ */
        
        #orderList { margin-top: 20px; border-top: 2px solid #00B900; padding-top: 10px; }
        .item-row { border-bottom: 1px dashed #eee; padding: 8px 0; }
    </style>
</head>
<body>

    <h2>å•†å“å—æ³¨å…¥åŠ›</h2>

    <div class="card">
        <h3>å•†å“å…¥åŠ›</h3>
        <button class="btn-scan" onclick="scanBarcode()">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
        
        <label>JANã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="janCode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·">
        
        <label>å•†å“å</label>
        <input type="text" id="itemName" placeholder="å•†å“åã‚’å…¥åŠ›">
        
        <label>æ•°é‡</label>
        <input type="number" id="quantity" value="1" min="1">
        
        <button class="btn-add" onclick="addToCart()">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div id="orderList">
        <h3>æ³¨æ–‡ãƒªã‚¹ãƒˆ</h3>
        <div id="items">
            <p style="color: #888;">ãƒªã‚¹ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
        <button class="btn-send" onclick="sendOrder()">ã“ã®å†…å®¹ã§æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let cart = [];

        // 1. LIFFã®åˆæœŸåŒ–
        async function initLiff() {
            try {
                // â˜…ã‚ãªãŸã® LIFF ID ã«æ›¸ãæ›ãˆã¾ã—ãŸ
                await liff.init({ liffId: "2006764491-L32vX6j0" }); 
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFFåˆæœŸåŒ–å¤±æ•—", err);
            }
        }
        initLiff();

        // 2. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
        async function scanBarcode() {
            if (!liff.isInClient()) {
                alert("LINEã‚¢ãƒ—ãƒªå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„");
                return;
            }
            try {
                const result = await liff.scanCodeV2();
                document.getElementById('janCode').value = result.value;
                document.getElementById('itemName').value = "èª­ã¿å–ã‚Šå•†å“ (" + result.value + ")";
            } catch (err) {
                console.error(err);
                alert("ã‚¹ã‚­ãƒ£ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã€å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // 3. æ³¨æ–‡ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒˆï¼‰ã«è¿½åŠ 
        function addToCart() {
            const jan = document.getElementById('janCode').value;
            const name = document.getElementById('itemName').value;
            const qty = document.getElementById('quantity').value;

            if (!name) {
                alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            cart.push({ jan, name, qty });
            renderCart();

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('janCode').value = "";
            document.getElementById('itemName').value = "";
            document.getElementById('quantity').value = "1";
        }

        // 4. ã‚«ãƒ¼ãƒˆã®ä¸­èº«ã‚’ç”»é¢ã«è¡¨ç¤º
        function renderCart() {
            const div = document.getElementById('items');
            if (cart.length === 0) {
                div.innerHTML = '<p style="color: #888;">ãƒªã‚¹ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            div.innerHTML = cart.map((item, index) => `
                <div class="item-row">
                    <strong>${item.name}</strong> Ã— ${item.qty}å€‹<br>
                    <small style="color:#666;">JAN: ${item.jan || 'ãªã—'}</small>
                </div>
            `).join('');
        }

        // 5. GASï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã¸é€ä¿¡
        async function sendOrder() {
            if (cart.length === 0) {
                alert("æ³¨æ–‡ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }

            try {
                const profile = await liff.getProfile();
                
                // é€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const data = {
                    userName: profile.displayName,
                    itemName: cart.map(i => `${i.name}(${i.jan || 'N/A'})`).join(" / "),
                    quantity: cart.reduce((sum, i) => sum + parseInt(i.qty), 0),
                    totalAmount: "è¦ç¢ºèª" // å¿…è¦ã«å¿œã˜ã¦è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
                };

                // â˜…ã‚ãªãŸã® GAS URL ã«æ›¸ãæ›ãˆã¾ã—ãŸ
                const gasUrl = "https://script.google.com/macros/s/AKfycbyRsSAmqoM5YFmgfQ82TLWake1K5u78UiO7ap5iY9pvJkFpQVhIEVIB-BGIJEVgLDuJww/exec";

                const response = await fetch(gasUrl, {
                    method: "POST",
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é€ä¿¡å®Œäº†ã—ã¾ã—ãŸã€‚");
                    liff.closeWindow(); // ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã‚‹
                } else {
                    alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ(400/500)");
                }
            } catch (err) {
                console.error(err);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
            }
        }
    </script>
</body>
</html>
