<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…è”µã‚¹ã‚­ãƒ£ãƒŠãƒ¼å—æ³¨ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #00B900; color: white; border: none; font-weight: bold; }
        #interactive.viewport { width: 100%; height: 250px; overflow: hidden; position: relative; background: #000; display: none; }
        #interactive.viewport canvas, video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <h2>å†…è”µã‚¹ã‚­ãƒ£ãƒŠãƒ¼å—æ³¨</h2>
    <div class="card">
        <div id="interactive" class="viewport"></div>
        <button id="scanBtn" onclick="startScanner()" style="background:#555;">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>
        
        <input type="text" id="janCode" placeholder="JANã‚³ãƒ¼ãƒ‰">
        <input type="text" id="itemName" placeholder="å•†å“å">
        <input type="number" id="quantity" value="1">
        <button onclick="addToCart()" style="background:#007bff;">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div id="orderList">
        <h3>æ³¨æ–‡ãƒªã‚¹ãƒˆ</h3>
        <div id="items"></div>
        <button onclick="sendOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function initLiff() {
            await liff.init({ liffId: "2008900667-HkwbRxSb" });
            if (!liff.isLoggedIn()) { liff.login(); }
        }
        initLiff();

        // å†…è”µã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°
        function startScanner() {
            const viewport = document.getElementById('interactive');
            viewport.style.display = 'block';
            
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: viewport },
                decoder: { readers: ["ean_reader"] } // JANã‚³ãƒ¼ãƒ‰ç”¨
            }, function(err) {
                if (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); return; }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                document.getElementById('janCode').value = result.codeResult.code;
                document.getElementById('itemName').value = "ã‚¹ã‚­ãƒ£ãƒ³å•†å“(" + result.codeResult.code + ")";
                Quagga.stop();
                viewport.style.display = 'none';
                alert("èª­ã¿å–ã‚ŠæˆåŠŸï¼");
            });
        }

        // --- ä»¥ä¸‹ã® addToCart, renderCart, sendOrder ã¯å‰å›ã¨åŒã˜ ---
        let cart = [];
        function addToCart() {
            cart.push({
                jan: document.getElementById('janCode').value,
                name: document.getElementById('itemName').value,
                qty: document.getElementById('quantity').value
            });
            renderCart();
        }
        function renderCart() {
            document.getElementById('items').innerHTML = cart.map(i => `<div>${i.name} x ${i.qty}</div>`).join('');
        }
        async function sendOrder() {
            const profile = await liff.getProfile();
            const gasUrl = "https://script.google.com/macros/s/AKfycbyRsSAmqoM5YFmgfQ82TLWake1K5u78UiO7ap5iY9pvJkFpQVhIEVIB-BGIJEVgLDuJww/exec";
            await fetch(gasUrl, {
                method: "POST",
                body: JSON.stringify({
                    userName: profile.displayName,
                    itemName: cart.map(i => i.name).join(", "),
                    quantity: cart.length
                })
            });
            alert("é€ä¿¡å®Œäº†");
            liff.closeWindow();
        }
    </script>
</body>
</html>
