<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…è”µã‚¹ã‚­ãƒ£ãƒŠãƒ¼å—æ³¨ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
   <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f4; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #00B900; }
        
        /* å…¥åŠ›é …ç›®ã¨ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        button { background: #00B900; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:active { opacity: 0.8; } /* æŠ¼ã—ãŸæ™‚ã«å°‘ã—è‰²ãŒå¤‰ã‚ã‚‹ */

        /* â˜…ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å¤§ããã€ã‚¹ãƒãƒ›ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹è¨­å®š */
        #interactive.viewport { 
            width: 100%; 
            height: 350px; /* é«˜ã•ã‚’250pxã‹ã‚‰350pxã«ã‚¢ãƒƒãƒ— */
            overflow: hidden; 
            position: relative; 
            background: #000; 
            display: none; 
            border-radius: 12px; 
            border: 3px solid #00B900; /* èª­ã¿å–ã‚Šä¸­ã¨åˆ†ã‹ã‚Šã‚„ã™ãæ ã‚’ä»˜ã‘ã‚‹ */
        }
        
        /* æ˜ åƒã‚’æ ã„ã£ã±ã„ã«åºƒã’ã‚‹è¨­å®š */
        #interactive.viewport video, #interactive.viewport canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* éš™é–“ãªãæ˜ åƒã‚’åºƒã’ã‚‹ */
        }
    </style>
</head>
<body>
    <h2>å†…è”µã‚¹ã‚­ãƒ£ãƒŠãƒ¼å—æ³¨</h2>
    <div class="card">
        <div id="interactive" class="viewport"></div>
        <button id="scanBtn" onclick="startScanner()" style="background:#555;">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>
        
        <input type="text" id="janCode" placeholder="JANã‚³ãƒ¼ãƒ‰">
        <input type="text" id="itemName" placeholder="å•†å“å">
        <input type="number" id="quantity" value="1">
        <button onclick="addToCart()" style="background:#007bff;">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div id="orderList">
        <h3>æ³¨æ–‡ãƒªã‚¹ãƒˆ</h3>
        <div id="items"></div>
        <button onclick="sendOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    // 1. LIFF ID ã‚’è¨­å®š (ã‚ãªãŸã®ID)
    async function initLiff() {
        try {
            await liff.init({ liffId: "2008900667-HkwbRxSb" }); 
            if (!liff.isLoggedIn()) { liff.login(); }
        } catch (err) {
            alert("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err);
        }
    }
    initLiff();

    // 2. ã‚«ãƒ¡ãƒ©èµ·å‹•
    function startScanner() {
        const viewport = document.getElementById('interactive');
        viewport.style.display = 'block';
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: viewport,
                constraints: {
                    facingMode: "environment"
                },
            },
            decoder: { readers: ["ean_reader"] }
        }, function(err) {
            if (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + err); return; }
            Quagga.start();
        });
        Quagga.onDetected(function(result) {
            document.getElementById('janCode').value = result.codeResult.code;
            document.getElementById('itemName').value = "ã‚¹ã‚­ãƒ£ãƒ³å•†å“(" + result.codeResult.code + ")";
            Quagga.stop();
            viewport.style.display = 'none';
        });
    }

    let cart = [];
    function addToCart() {
        const jan = document.getElementById('janCode').value;
        const name = document.getElementById('itemName').value;
        const qty = document.getElementById('quantity').value;

        if (!name) { alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        cart.push({ jan, name, qty });
        renderCart();

        // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('janCode').value = "";
        document.getElementById('itemName').value = "";
        document.getElementById('quantity').value = "1";
    }

    function renderCart() {
        const div = document.getElementById('items');
        div.innerHTML = cart.map(i => `
            <div style="border-bottom:1px solid #ddd; padding:5px;">
                ${i.name} x ${i.qty}å€‹
            </div>
        `).join('');
    }

    // 3. é€ä¿¡å‡¦ç†ï¼ˆã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼‰
    async function sendOrder() {
        if (cart.length === 0) {
            alert("ãƒªã‚¹ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“");
            return;
        }

        try {
            const profile = await liff.getProfile();
            // ã‚ãªãŸã®GAS URL
            const gasUrl = "https://script.google.com/macros/s/AKfycbyRsSAmqoM5YFmgfQ82TLWake1K5u78UiO7ap5iY9pvJkFpQVhIEVIB-BGIJEVgLDuJww/exec";
            
            // é€ä¿¡å†…å®¹ã®æ•´ç†
            const orderData = {
                userName: profile.displayName,
                itemName: cart.map(i => `${i.name}(${i.jan})`).join(", "),
                quantity: cart.reduce((sum, i) => sum + parseInt(i.qty), 0)
            };

            // GASã¸é€ä¿¡
            const response = await fetch(gasUrl, {
                method: "POST",
                mode: "no-cors", // é‡è¦ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData)
            });

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            alert("æ³¨æ–‡ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼");
            liff.closeWindow(); // ç”»é¢ã‚’é–‰ã˜ã‚‹

        } catch (error) {
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
    }
</script>
