<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç¢ºèªãƒ»å—æ³¨ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f4; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #00B900; }
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        button { background: #00B900; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        #statusInfo { margin-top: 5px; font-weight: bold; font-size: 14px; }
        .stock-label { color: #007bff; }
        .price-label { color: #e63946; margin-left: 10px; }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        #interactive.viewport { 
            width: 100%; 
            height: 300px; 
            overflow: hidden; 
            position: relative; 
            background: #000; 
            display: none; 
            border-radius: 12px; 
            border: 3px solid #00B900; 
        }
        #interactive.viewport video, #interactive.viewport canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
    </style>
</head>
<body>

    <h2>å†…è”µã‚¹ã‚­ãƒ£ãƒŠãƒ¼å—æ³¨</h2>

    <div class="card">
        <div id="interactive" class="viewport"></div>
        <button id="scanBtn" onclick="startScanner()" style="background:#555;">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>
        
        <input type="text" id="janCode" placeholder="JANã‚³ãƒ¼ãƒ‰">
        <input type="text" id="itemName" placeholder="å•†å“å/å“ç•ª">
        
        <div id="statusInfo">
            <span class="stock-label" id="dispStock">åœ¨åº«: ---</span>
            <span class="price-label" id="dispPrice">å˜ä¾¡: ---</span>
        </div>

        <input type="number" id="quantity" value="1" min="1">
        <button onclick="addToCart()" style="background:#007bff;">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>

    <div id="orderList" class="card">
        <h3>æ³¨æ–‡ãƒªã‚¹ãƒˆ</h3>
        <div id="items" style="margin-bottom:10px;"></div>
        <button id="submitBtn" onclick="sendOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>

<script>
    // --- ã€è¨­å®šã€‘ã‚ãªãŸã®æœ€æ–°ã®GAS URL ---
    const gasUrl = "https://script.google.com/macros/s/AKfycbwPci5JdzhT3OlOMcyI06bJHliPwA5-eQe2fjb3IkhQE8tBdRWSh4Lf9VqfQwhOi9ISbw/exec";

    // --- 1. LIFFåˆæœŸåŒ– ---
    async function initLiff() {
        try {
            await liff.init({ liffId: "2008900667-HkwbRxSb" }); 
            if (!liff.isLoggedIn()) { liff.login(); }
        } catch (err) { console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", err); }
    }
    initLiff();

    let isScanning = false; 

    // --- 2. ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹• ---
    function startScanner() {
        if (isScanning) return; 
        const viewport = document.getElementById('interactive');
        viewport.style.display = 'block';
        
        Quagga.init({
            inputStream: { 
                name: "Live", 
                type: "LiveStream", 
                target: viewport, 
                constraints: { facingMode: "environment" } 
            },
            decoder: { readers: ["ean_reader"], multiple: false }
        }, function(err) {
            if (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + err); return; }
            Quagga.start();
        });

        Quagga.onDetected(async function(result) {
            if (isScanning) return; 
            isScanning = true; 
            
            const code = result.codeResult.code;
            document.getElementById('janCode').value = code;
            
            // --- GASã«æƒ…å ±ã‚’å•ã„åˆã‚ã› ---
            try {
                const response = await fetch(`${gasUrl}?jan=${code}`);
                const data = await response.json();
                
                document.getElementById('itemName').value = data.name;
                document.getElementById('dispStock').innerText = "åœ¨åº«: " + data.stock;
                document.getElementById('dispPrice').innerText = "å˜ä¾¡: " + data.price + "å††";
            } catch (e) {
                document.getElementById('itemName').value = "å•†å“(" + code + ")";
            }
            
            Quagga.stop();
            viewport.style.display = 'none';
            setTimeout(() => { isScanning = false; }, 1500);
        });
    }

    // --- 3. ãƒªã‚¹ãƒˆè¿½åŠ å‡¦ç† ---
    let cart = [];
    function addToCart() {
        const jan = document.getElementById('janCode').value;
        const name = document.getElementById('itemName').value;
        const qty = document.getElementById('quantity').value;
        if (!name || !jan) { alert("å•†å“ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“"); return; }

        cart.push({ jan, name, qty });
        renderCart();

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('janCode').value = "";
        document.getElementById('itemName').value = "";
        document.getElementById('quantity').value = "1";
        document.getElementById('dispStock').innerText = "åœ¨åº«: ---";
        document.getElementById('dispPrice').innerText = "å˜ä¾¡: ---";
    }

    function renderCart() {
        const div = document.getElementById('items');
        div.innerHTML = cart.map((i, index) => `
            <div style="border-bottom:1px solid #ddd; padding:8px; display:flex; justify-content:space-between; align-items:center;">
                <span>${i.name} x ${i.qty}</span>
                <span style="color:red; cursor:pointer;" onclick="removeItem(${index})">âœ• å‰Šé™¤</span>
            </div>
        `).join('');
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // --- 4. æ³¨æ–‡é€ä¿¡ ---
    async function sendOrder() {
        if (cart.length === 0) { alert("ãƒªã‚¹ãƒˆãŒç©ºã§ã™"); return; }
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerText = "é€ä¿¡ä¸­...";

        try {
            const profile = await liff.getProfile();
            const orderData = { userName: profile.displayName, orders: cart };

            await fetch(gasUrl, {
                method: "POST",
                mode: "no-cors", // CORSã‚¨ãƒ©ãƒ¼å›é¿
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData)
            });

            alert("æ³¨æ–‡ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼");
            liff.closeWindow();
        } catch (error) {
            alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
            submitBtn.disabled = false;
            submitBtn.innerText = "æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹";
        }
    }
</script>
</body>
</html>
