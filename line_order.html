<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå¤å±‹èŠ±ãå•†äº‹æœ¬éƒ¨å—æ³¨ã‚¢ãƒ—ãƒª</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { font-size: 20px; text-align: center; color: #2c3e50; margin-bottom: 20px; }
        h3 { color: #28a745; border-left: 5px solid #28a745; padding-left: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .item-card { background: #fdfdfd; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .item-label { font-weight: bold; color: #000; }
        .remove-btn { background: #ff4d4d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .add-btn { background: #888; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 20px; }
        #sendBtn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .loading { display: none; text-align: center; margin-top: 10px; font-weight: bold; }
        #userInfo { font-size: 12px; color: #000; text-align: right; margin-bottom: 10px; font-weight: bold; }
        
        /* å…¥è·æƒ…å ±ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .arrival-section { display: none; background: #fffde7; border: 1px solid #fbc02d; border-radius: 8px; margin-bottom: 20px; padding: 10px; }
        .arrival-header { font-weight: bold; color: #f57f17; border-bottom: 1px dotted #fbc02d; margin-bottom: 5px; font-size: 14px; }
        
        /* å±¥æ­´ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .history-section { display: none; margin-bottom: 20px; border: 1px solid #999; border-radius: 8px; overflow: hidden; }
        .history-header { background: #777; color: white; padding: 8px; font-size: 14px; font-weight: bold; }
        .history-list { max-height: 200px; overflow-y: auto; background: #fff; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .history-date { color: #888; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>åå¤å±‹èŠ±ãå•†äº‹æœ¬éƒ¨æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </h2>
    <div id="userInfo">LIFFåˆæœŸåŒ–ä¸­...</div>

    <div id="arrivalSection" class="arrival-section">
        <div class="arrival-header">ğŸšš ç›´è¿‘1é€±é–“ã®å…¥è·äºˆå®š</div>
        <div id="arrivalList"></div>
    </div>

    <div id="historySection" class="history-section">
        <div class="history-header">éå»ã®æ³¨æ–‡å±¥æ­´ (ã‚¿ãƒƒãƒ—ã§å†æ³¨æ–‡)</div>
        <div id="historyList" class="history-list">
            <div style="padding:10px;">èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
    </div>

    <div class="input-group">
        <label>åº—å</label>
        <input type="text" id="storeName" placeholder="å¿…é ˆå…¥åŠ›">
    </div>
    <div class="input-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="email" placeholder="æ§ãˆé€ä¿¡å…ˆ">
    </div>

    <hr>
    <h3>æ³¨æ–‡å†…å®¹</h3>
    
    <div id="itemContainer">
        <div class="item-card">
            <div class="item-header"><span class="item-label">å•†å“</span></div>
            <div class="input-group">
                <label>äº”åéŸ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</label>
                <select class="category-select" onchange="updateMakerOptions(this)">
                    <option value="">â–¼ è¡Œã‚’é¸æŠ</option>
                    <option value="ã‚">ã‚è¡Œ</option><option value="ã‹">ã‹è¡Œ</option><option value="ã•">ã•è¡Œ</option>
                    <option value="ãŸ">ãŸè¡Œ</option><option value="ãª">ãªè¡Œ</option><option value="ã¯">ã¯è¡Œ</option>
                    <option value="ã¾">ã¾è¡Œ</option><option value="ã‚„">ã‚„è¡Œ</option><option value="ã‚‰">ã‚‰è¡Œ</option>
                    <option value="ã‚">ã‚è¡Œ</option><option value="ãã®ä»–">ãã®ä»–</option>
                </select>
            </div>
            <div class="input-group">
                <label>ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
                <select class="maker-select"><option value="">è¡Œã‚’é¸ã‚“ã§ãã ã•ã„</option></select>
            </div>
            <div class="input-group">
                <label>å“ç•ª / æ•°é‡</label>
                <input type="text" class="partNo-input" placeholder="å“ç•ª">
                <input type="number" class="quantity-input" value="1" min="1" style="margin-top:5px;">
            </div>
        </div>
    </div>

    <button type="button" class="add-btn" onclick="addNewItem()">ï¼‹ å•†å“ã‚’è¿½åŠ ã™ã‚‹</button>

    <div class="input-group"><label>ç”»åƒæ·»ä»˜1</label><input type="file" id="imageFile1" accept="image/*"></div>
    <div class="input-group"><label>ç”»åƒæ·»ä»˜2</label><input type="file" id="imageFile2" accept="image/*"></div>
    <div class="input-group"><label>å‚™è€ƒ</label><textarea id="comments" rows="3"></textarea></div>

    <button id="sendBtn" onclick="sendOrder()">æ³¨æ–‡ã‚’é€ä¿¡ã™ã‚‹</button>
    <div id="loadingMsg" class="loading">é€ä¿¡ä¸­...</div>
</div>

<script>
    const gasUrl = "https://script.google.com/macros/s/AKfycbyDMUsoLiBW26V0m6BBq7S5rIlhaCQXOPdG_2__V9E9aoFqyWEZikDuEE1K0Gc8r6d-/exec"; 
    let currentUserProfile = null;

    const allMakers = [
        "ã‚ã„ã¯ã‚‰ã¼ã†ãˆã:ã‚¢ã‚¤ãƒãƒ©è²¿æ˜“ï¼ˆãƒãƒªãƒ©ãƒ•ã‚£ã‚¢)", "ã‚ã™ã‹ã—ã‚‡ã†ã‹ã„:ã‚¢ã‚¹ã‚«å•†ä¼š", "ã‚ãšã‚ã‚“:ã‚¢ã‚ºãƒ¯ãƒ³ï¼ˆè©¦é¨“ç®¡ï¼‰", 
        "ã‚ã‚‚ã‚ãƒ¼ã•:ã‚¢ãƒ ãƒ¼ãƒ«ãƒ‡ãƒ•ãƒ«ãƒ¼ãƒ«", "ã‚ã‚€ãƒ¼ã‚‹ã§ãµã‚‹ãƒ¼ã‚‹:ã‚¢ãƒ ãƒ¼ãƒ«ãƒ‡ãƒ•ãƒ«ãƒ¼ãƒ«", "ã‚ã‚“ã“ãƒ¼ã½ã‚Œãƒ¼ã—ã‚‡ã‚“:ã‚¢ãƒ³ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³", 
        "ã‚ãƒ¼ã¦ãƒãµãƒã—ã‚ƒã‚‹:ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚£ã‚·ãƒ£ãƒ«", "ã‚ãŠã‚„ã¾ã‚Šã¼ã‚“:é’å±±ãƒªãƒœãƒ³", "ã‚ã•ã²ã‚ã„ã‚„ãƒ¼:æœæ—¥ãƒ¯ã‚¤ãƒ¤ãƒ¼", "ã¹ã‚‹ã§:ãƒ´ã‚§ãƒ«ãƒ‡",
        "ãŠãŠã¡ã®ã†ãˆã‚“:å¤§åœ°è¾²åœ’", "ãŠãŠãã¡ã•ã‚“ãã‚‡ã†:å¤§å£ç”£æ¥­", "ã ã„ã¦ã¤:å¤§é‰„", "ã ã„ã©ã†ãã‚‰ãµã¨:å¤§åŒã‚¯ãƒ©ãƒ•ãƒˆ", "ã„ã‚“ãŸãƒ¼ã‚Šã‚“ã:ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ³ã‚¯",
        "ã ã„ã›ã‚“:å¤§ä»™", "ã†ã‰ã‚‹ãªã£ã¨:ã‚¦ã‚©ãƒ«ãƒŠãƒƒãƒˆ", "ãˆã“ãœã‚Šãƒ¼:ã‚¨ã‚³ã‚¼ãƒªãƒ¼", "ãˆã‚‹ã“ã¿ã‚…ãƒ¼ã‚“:ã‚¨ãƒ«ã‚³ãƒŸãƒ¥ãƒ¼ãƒ³", "ãˆã™ã‚ãƒ¼ã‚‹ã•ãƒ¼ã³ã™:SRã‚µãƒ¼ãƒ“ã‚¹(ãƒ‡ã‚³ã‚¸ãƒ£ãƒªï¼‰",
        "ãˆã„ã¡ã¤ãƒ¼ãŠãƒ¼:ã‚¨ã‚¤ãƒãƒ„ãƒ¼ã‚ªãƒ¼", "ã‹ã‚ã‚„ã¾ãã‚ƒãƒ³ãƒ‰ã‚‹:ã‚«ãƒ¡ãƒ¤ãƒã‚­ãƒ£ãƒ³ãƒ‰ãƒ«", "ã‹ã‚‹ãªã£ã:ã‚«ãƒ«ãƒŠãƒƒã‚¯", "ãã‚…ãƒ¼ãµã‚‰:Q-FLA",
        "ãã‚Œã„:ã‚¯ãƒ¬ã‚¤", "ãã‚Šã–ãƒ¼ã‚‹:ã‚¯ãƒªã‚¶ãƒ¼ãƒ«", "ãã‚Œãˆ:ã‚¯ãƒ¬ã‚¨", "ãã‚Šãƒ¼ã‚“ã¯ã†ã™:ã‚°ãƒªãƒ¼ãƒ³ãƒã‚¦ã‚¹", "ãã‚ƒã³ã®ã¡ã‡:ã‚­ãƒ£ãƒ“ãƒãƒã‚§",
        "ãã‚Šãƒ¼ã‚“ã½ã£ã¨:ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒãƒˆ", "ãã‚ãƒ¼ã°ã‚‹ã‚ã‚ãƒ¼:ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ­ãƒ¼", "ã“ã‚ã¨ã‚Œãƒ¼ã§ãƒã‚“ã:ã‚³ã‚¢ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°", 
        "ã“ã¹ã‚“ã¨ãŒãƒ¼ã§ã‚“:ã‚³ãƒ™ãƒ³ãƒˆã‚¬ãƒ¼ãƒ‡ãƒ³", "ã•ã‹ã’ã‚“:å‚æº", "ã•ã‚“ã‚ã¨ã‚Œãƒ¼ã§ãƒã‚“ã:ä¸‰å’Œãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°", 
        "ã—ã‚‚ã˜ã¾:ã‚·ãƒ¢ã‚¸ãƒ", "ã—ã›ã„ã¯ã‚“ã±ã„:å¿—æˆè²©å£²", "ã™ã¿ã–ãƒ¼ãšãŠã‚ã—ã™:ã‚¹ãƒŸã‚¶ãƒ¼ã‚ºã‚ªã‚¢ã‚·ã‚¹", 
        "ã¨ã‚„ã¾ã¯ã‚‚ã®:å¤–å±±åˆƒç‰©", "ãŸãªã‹ã¨ã†ã:ç”°ä¸­é™¶å™¨", "ã ã‚‹ã¨ã‚“:ãƒ€ãƒ«ãƒˆãƒ³", "ã§ã‚‹ã:ãƒ‡ãƒ«ã‚­",
        "ã¨ã†ãã‚‡ã†ã‚Šã¼ã‚“:æ±äº¬ãƒªãƒœãƒ³", "ã¨ã†ãã‚‡ã†ã‹ã‚“ã‹ã‚“:æ±äº¬ã‹ã‚“ã‹ã‚“", "ã¨ã™ã ã„ã™:TOSSDICE", "ã ã‚“ã¼ãƒ¼ã‚‹:æ®µãƒœãƒ¼ãƒ«",
        "ã¨ã†ãã‚‡ã†ã©ã†:æ±äº¬å ‚", "ã¨ãƒ¼ã:ãƒˆãƒ¼ã‚¯", "ã©ã‚Šãƒ¼ã‚€ãµããƒ¼ã‚€ã™ãšã‹:ãƒ‰ãƒªãƒ¼ãƒ ãƒ•ã‚¡ãƒ¼ãƒ ã‚¹ã‚ºã‚«", "ã¨ã†ã‹:æ±èŠ±", "ã¨ã†ã»ã†ã¼ã†ãˆã:æ±æ–¹è²¿æ˜“",
        "ã­ã„ã¡ã‚ƒãƒ¼ã§ã–ã„ã‚“ãš:ãƒã‚¤ãƒãƒ£ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ã‚º", "ã±ã‚Œã™ã‹ãŒã:ãƒ‘ãƒ¬ã‚¹åŒ–å­¦", "ã±ã‚Œ:ãƒ‘ãƒ¬", "ã½ã£ã—ã‚…ã‚Šã³ã‚“ã:ãƒãƒƒã‚·ãƒ¥ãƒªãƒ“ãƒ³ã‚°",
        "ãµããƒ¼ã‚€:FARM", "ã¯ãªã‚Šã‚“ãã™:èŠ±Links", "ãµã‚ãƒ¼ãƒãƒƒãƒˆ:flonet", "ã»ã‚ã„ãˆ:ãƒ›ãƒ¯ã‚¤ã‚¨", "ã¯èŠ±ã®ãã®ãã¼ãŸ:èŠ±ã®ãã®ãã¼ãŸ",
        "ãµã‚ãƒ¼ã‚‹ãˆã°ãƒ¼:ãƒ•ãƒ­ãƒ¼ãƒ«ã‚¨ãƒãƒ¼", "ãµã‚‰ã‚ãƒ¼ã¹ãƒ¼ã™:ãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ™ãƒ¼ã‚¹", "ã·ã‚‰ã™ãŒãƒ¼ã§ã‚“:ãƒ—ãƒ©ã‚¹ã‚¬ãƒ¼ãƒ‡ãƒ³", 
        "ã¼ã¶ãã‚‰ãµã¨:ãƒœãƒ–ã‚¯ãƒ©ãƒ•ãƒˆ", "ã¾ã¤ã‚€ã‚‰ã“ã†ã’ã„:æ¾æ‘å·¥èŠ¸", "ã»ã—ã®:æ˜Ÿé‡",
        "ã¾ãã­ã£ã¨:ãƒã‚°ãƒãƒƒãƒˆ", "ã¾ã‚‹ã“ã†ã›ã„ã¨ã†:ä¸¸æ»‰è£½é™¶", "ã¾ã‚‹ã¾ã²ã‚‰ã®ã¨ã†ãã¦ã‚“:ä¸¸åˆå¹³é‡é™¶å™¨åº—", 
        "ã¾ã‚‹ã‚ã¼ã†ãˆã:ä¸¸å’Œè²¿æ˜“", "ã¿ã‚…ãƒ¼ã‚‹ã¿ã‚‹:ãƒŸãƒ¥ãƒ¼ãƒ«ãƒŸãƒ«", "ã‚€ã‚‰ãŸã‚„ã•ã‚“ãã‚‡ã†:æ‘ç”°å±‹ç”£æ¥­", 
        "ã‚‚ã®ã„ã‚“ãŸãƒ¼ãªã—ã‚‡ãªã‚‹:ãƒ¢ãƒãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠã‚·ãƒ§ãƒŠãƒ«", "ã‚„ã¾ã¦ãƒ¼:ãƒ¤ãƒãƒ†ãƒ¼", "ã‚„ãƒ¼ã©:yard", "ã‚†ã†ãœã‚“:å‹è†³",
        "ã‚ˆã“ã¯ã¾ã§ãƒã™ã·ã‚Œã„ã¿ã‚…ãƒ¼ã˜ã‚ã‚€:æ¨ªæµœãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ", "ã‚‰ã‚‰ã„ã‚ã‚“ã¨:ãƒ©ãƒ©ã‚¤ãƒ¯ãƒ³ãƒˆ", "ã‚Šã¶ãã‚…ã‚Šãˆã„ã¨:Lib curate", 
        "ã‚Šãƒ¼ã©ã—ã‚‡ã†ã˜:ãƒªãƒ¼ãƒ‰å•†äº‹", "ã‚ã•ã‚‰:WASARA", "ã‚ã‚“ã ãƒ¼ããƒ¼ã‚“:ãƒ¯ãƒ³ãƒ€ãƒ¼ã‚¾ãƒ¼ãƒ³", "ã‚ã“ã†ã‹ãŒã:å’Œå…‰åŒ–å­¦"
    ];

    function getKanaRow(kana) {
        const first = kana.charAt(0);
        if (/[ã‚-ãŠ]/.test(first)) return "ã‚";
        if (/[ã‹-ã“ãŒ-ã”]/.test(first)) return "ã‹";
        if (/[ã•-ãã–-ã]/.test(first)) return "ã•";
        if (/[ãŸ-ã¨ã -ã©]/.test(first)) return "ãŸ";
        if (/[ãª-ã®]/.test(first)) return "ãª";
        if (/[ã¯-ã»ã°-ã¼ã±-ã½]/.test(first)) return "ã¯";
        if (/[ã¾-ã‚‚]/.test(first)) return "ã¾";
        if (/[ã‚„-ã‚ˆ]/.test(first)) return "ã‚„";
        if (/[ã‚‰-ã‚]/.test(first)) return "ã‚‰";
        if (/[ã‚-ã‚“]/.test(first)) return "ã‚";
        return "ãã®ä»–";
    }

    function updateMakerOptions(catSelect) {
        const row = catSelect.value;
        const makerSelect = catSelect.closest('.item-card').querySelector('.maker-select');
        makerSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        if (row === "ãã®ä»–") { makerSelect.innerHTML = '<option value="å‚™è€ƒã«è¨˜å…¥">å‚™è€ƒã«è¨˜å…¥</option>'; return; }
        if (!row) { makerSelect.innerHTML = '<option value="">è¡Œã‚’é¸ã‚“ã§ãã ã•ã„</option>'; return; }
        allMakers.filter(item => getKanaRow(item.split(':')[0]) === row).forEach(item => {
            const name = item.split(':')[1];
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            makerSelect.appendChild(opt);
        });
    }

    // --- å…¥è·äºˆå®šã¨å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€é–¢æ•° ---
    async function loadAppData(userId) {
        const arrivalSection = document.getElementById('arrivalSection');
        const arrivalList = document.getElementById('arrivalList');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');

        try {
            const response = await fetch(`${gasUrl}?userId=${userId}&t=${new Date().getTime()}`);
            const result = await response.json();

            // å…¥è·äºˆå®š
            if (result.calendar && result.calendar.length > 0) {
                arrivalSection.style.display = 'block';
                arrivalList.innerHTML = result.calendar.map(c => `
                    <div style="font-size:13px; padding:3px 0; border-bottom:1px solid #eee;">ğŸ“… ${c.date} : ${c.title}</div>
                `).join('');
            } else { arrivalSection.style.display = 'none'; }

            // å±¥æ­´
            if (result.history && result.history.length > 0) {
                historySection.style.display = 'block';
                historyList.innerHTML = result.history.map(h => `
                    <div class="history-item" onclick="applyHistory('${h.maker}', '${h.partNo}', '${h.quantity}')">
                        <span class="history-date">${h.date}</span><br>
                        <strong>${h.maker}</strong> / ${h.partNo} (æ•°é‡: ${h.quantity})
                    </div>
                `).join('');
            } else { historySection.style.display = 'none'; }

        } catch (e) { console.error("Data Load Error", e); }
    }

    function applyHistory(maker, partNo, quantity) {
        if (!confirm(`${maker} ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const container = document.getElementById('itemContainer');
        const cards = container.querySelectorAll('.item-card');
        let targetCard = (cards.length === 1 && !cards[0].querySelector('.partNo-input').value) ? cards[0] : null;
        if (!targetCard) { addNewItem(); const uCards = container.querySelectorAll('.item-card'); targetCard = uCards[uCards.length - 1]; }
        targetCard.querySelector('.category-select').value = "ãã®ä»–";
        targetCard.querySelector('.maker-select').innerHTML = `<option value="${maker}">${maker}</option>`;
        targetCard.querySelector('.partNo-input').value = partNo;
        targetCard.querySelector('.quantity-input').value = quantity;
    }

    function addNewItem() {
        const container = document.getElementById('itemContainer');
        const firstCard = container.querySelector('.item-card');
        const newCard = firstCard.cloneNode(true);
        newCard.querySelector('.item-header').innerHTML = '<span class="item-label">è¿½åŠ å•†å“</span><button type="button" class="remove-btn" onclick="this.closest(\'.item-card\').remove()">å‰Šé™¤</button>';
        newCard.querySelectorAll('input').forEach(i => i.value = (i.type === 'number' ? 1 : ''));
        newCard.querySelector('.maker-select').innerHTML = '<option value="">è¡Œã‚’é¸ã‚“ã§ãã ã•ã„</option>';
        newCard.querySelector('.category-select').value = "";
        container.appendChild(newCard);
    }

    async function sendOrder() {
        const btn = document.getElementById('sendBtn');
        const storeName = document.getElementById('storeName').value;
        if (!storeName) { alert('åº—åã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }

        const items = [];
        document.querySelectorAll('.item-card').forEach(card => {
            const m = card.querySelector('.maker-select').value;
            const p = card.querySelector('.partNo-input').value;
            const q = card.querySelector('.quantity-input').value;
            if (m) items.push({ maker: m, partNo: p, quantity: q });
        });
        if (items.length === 0) { alert('æ³¨æ–‡å•†å“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        btn.disabled = true; 
        btn.innerText = "é€ä¿¡ä¸­..."; 
        document.getElementById('loadingMsg').style.display = 'block';

        const readFile = (id) => {
            const file = document.getElementById(id).files[0];
            return new Promise((resolve) => {
                if (!file) resolve(null);
                else {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, name: file.name });
                    reader.readAsDataURL(file);
                }
            });
        };

        const [img1, img2] = await Promise.all([readFile('imageFile1'), readFile('imageFile2')]);
        const images = [img1, img2].filter(i => i !== null);

        const orderData = {
            storeName: storeName,
            email: document.getElementById('email').value,
            items: items,
            comments: document.getElementById('comments').value,
            userId: currentUserProfile ? currentUserProfile.userId : "unknown",
            images: images
        };

        try {
            await fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(orderData)
            });
            localStorage.setItem('storeName', storeName);
            localStorage.setItem('email', document.getElementById('email').value);
            alert('æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼'); 
            liff.closeWindow();
        } catch (e) {
            alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            btn.disabled = false;
            btn.innerText = "æ³¨æ–‡ã‚’é€ä¿¡ã™ã‚‹";
            document.getElementById('loadingMsg').style.display = 'none';
        }
    }

    async function initLiff() {
        try {
            await liff.init({ liffId: "2008835052-zCjbE0pV" });
            if (!liff.isLoggedIn()) { liff.login(); } else {
                currentUserProfile = await liff.getProfile();
                document.getElementById('userInfo').textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼: " + currentUserProfile.displayName;
                // ã“ã“ã§å…¥è·äºˆå®šã¨å±¥æ­´ã‚’ä¸¡æ–¹èª­ã¿è¾¼ã‚€
                loadAppData(currentUserProfile.userId);
            }
        } catch (e) { document.getElementById('userInfo').textContent = "åˆæœŸåŒ–å¤±æ•—"; }
    }

    window.onload = function() {
        initLiff();
        if (localStorage.getItem('storeName')) document.getElementById('storeName').value = localStorage.getItem('storeName');
        if (localStorage.getItem('email')) document.getElementById('email').value = localStorage.getItem('email');
    };
</script>
</body>
</html>
