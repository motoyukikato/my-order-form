<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>名古屋花き商事本部受注アプリ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { font-size: 20px; text-align: center; color: #2c3e50; margin-bottom: 20px; }
        h3 { color: #28a745; border-left: 5px solid #28a745; padding-left: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .item-card { background: #fdfdfd; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .item-label { font-weight: bold; color: #000; }
        .remove-btn { background: #ff4d4d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .add-btn { background: #888; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 20px; }
        #sendBtn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .loading { display: none; text-align: center; margin-top: 10px; font-weight: bold; }
        #userInfo { font-size: 12px; color: #000; text-align: right; margin-bottom: 10px; font-weight: bold; }
        .history-section { display: none; margin-bottom: 20px; border: 1px solid #999; border-radius: 8px; overflow: hidden; }
        .history-header { background: #777; color: white; padding: 8px; font-size: 14px; font-weight: bold; }
        .history-list { max-height: 200px; overflow-y: auto; background: #fff; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .history-item:hover { background: #f5f5f5; }
        .history-date { color: #888; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>名古屋花き商事本部注文フォーム</h2>
    <div id="userInfo">LIFF初期化中...</div>

    <div id="historySection" class="history-section">
        <div class="history-header">過去の注文履歴 (タップで再注文)</div>
        <div id="historyList" class="history-list">
            <div style="padding:10px;">履歴を読み込んでいます...</div>
        </div>
    </div>

    <div class="input-group">
        <label>店名</label>
        <input type="text" id="storeName" placeholder="必須入力">
    </div>
    <div class="input-group">
        <label>メールアドレス</label>
        <input type="email" id="email" placeholder="控え送信先">
    </div>

    <hr>
    <h3>注文内容</h3>
    
    <div id="itemContainer">
        <div class="item-card">
            <div class="item-header"><span class="item-label">商品</span></div>
            <div class="input-group">
                <label>五十音インデックス</label>
                <select class="category-select" onchange="updateMakerOptions(this)">
                    <option value="">▼ 行を選択</option>
                    <option value="あ">あ行</option><option value="か">か行</option><option value="さ">さ行</option>
                    <option value="た">た行</option><option value="な">な行</option><option value="は">は行</option>
                    <option value="ま">ま行</option><option value="や">や行</option><option value="ら">ら行</option>
                    <option value="わ">わ行</option><option value="その他">その他</option>
                </select>
            </div>
            <div class="input-group">
                <label>メーカー</label>
                <select class="maker-select"><option value="">行を選んでください</option></select>
            </div>
            <div class="input-group">
                <label>品番 / 数量</label>
                <input type="text" class="partNo-input" placeholder="品番">
                <input type="number" class="quantity-input" value="1" min="1" style="margin-top:5px;">
            </div>
        </div>
    </div>

    <button type="button" class="add-btn" onclick="addNewItem()">＋ 商品を追加する</button>

   <div class="input-group"><label>画像添付1</label><input type="file" id="imageFile1" accept="image/*"></div>
    <div class="input-group"><label>画像添付2</label><input type="file" id="imageFile2" accept="image/*"></div>
    <div class="input-group"><label>備考</label><textarea id="comments" rows="3"></textarea></div>

    <button id="sendBtn" onclick="sendOrder()">注文を送信する</button>
    <div id="loadingMsg" class="loading">送信中...</div>
</div>

<script>
    const gasUrl = "https://script.google.com/macros/s/AKfycbzhP0g5KldIuA1Iw7av8bdwvIfDSAQc67-cF9cQ0T3n_zScbHqGyGkca5f4BVGk8OyL/exec"; 
    let currentUserProfile = null;

    const allMakers = [
        "あいはらぼうえき:アイハラ貿易（ポリラフィア)", "あすかしょうかい:アスカ商会", "あずわん:アズワン（試験管）", 
        "あもろーさ:アムールデフルール", "あむーるでふるーる:アムールデフルール", "あんこーぽれーしょん:アンコーポレーション", 
        "あーてぃふぃしゃる:アーティフィシャル", "あおやまりぼん:青山リボン", "あさひわいやー:朝日ワイヤー", "べるで:ヴェルデ",
        "おおちのうえん:大地農園", "おおぐちさんぎょう:大口産業", "だいてつ:大鉄", "だいどうくらふと:大同クラフト", "いんたーりんく:インターリンク",
        "だいせん:大仙", "うぉるなっと:ウォルナット", "えこぜりー:エコゼリー", "えるこみゅーん:エルコミューン", "えすあーるさーびす:SRサービス(デコジャリ）",
        "えいちつーおー:エイチツーオー", "かめやまきゃンドる:カメヤマキャンドル", "かるなっく:カルナック", "きゅーふら:Q-FLA",
        "くれい:クレイ", "くりざーる:クリザール", "くれえ:クレエ", "ぐりーんはうす:グリーンハウス", "きゃびのちぇ:キャビノチェ",
        "ぐりーんぽっと:グリーンポット", "ぐろーばるあろー:グローバルアロー", "こあとれーでぃんぐ:コアトレーディング", 
        "こべんとがーでん:コベントガーデン", "さかげん:坂源", "さんわとれーでぃんぐ:三和トレーディング", 
        "しもじま:シモジマ", "しせいはんぱい:志成販売", "すみざーずおあしす:スミザーズオアシス", 
        "とやまはもの:外山刃物", "たなかとうき:田中陶器", "だるとん:ダルトン", "でるき:デルキ",
        "とうきょうりぼん:東京リボン", "とうきょうかんかん:東京かんかん", "とすだいす:TOSSDICE", "だんぼーる:段ボール",
        "とうきょうどう:東京堂", "とーく:トーク", "どりーむふぁーむすずか:ドリームファームスズカ", "とうか:東花", "とうほうぼうえき:東方貿易",
        "ねいちゃーでざいんず:ネイチャーデザインズ", "ぱれすかがく:パレス化学", "ぱれ:パレ", "ぽっしゅりびんぐ:ポッシュリビング",
        "ふぁーむ:FARM", "はなりんくす:花Links", "ふろーネット:flonet", "ほわいえ:ホワイエ", "は花のそのくぼた:花のそのくぼた",
        "ふろーるえばー:フロールエバー", "ふらわーべーす:フラワーベース", "ぷらすがーでん:プラスガーデン", 
        "ぼぶくらふと:ボブクラフト", "まつむらこうげい:松村工芸", "ほしの:星野",
        "まぐねっと:マグネット", "まるこうせいとう:丸滉製陶", "まるまひらのとうきてん:丸又平野陶器店", 
        "まるわぼうえき:丸和貿易", "みゅーるみる:ミュールミル", "むらたやさんぎょう:村田屋産業", 
        "ものいんたーなしょなる:モノ・インターナショナル", "やまてー:ヤマテー", "やーど:yard", "ゆうぜん:友膳",
        "よこはまでぃすぷれいみゅーじあむ:横浜ディスプレイミュージアム", "ららいわんと:ラライワント", "りぶきゅりえいと:Lib curate", 
        "りーどしょうじ:リード商事", "わさら:WASARA", "わんだーぞーん:ワンダーゾーン", "わこうかがく:和光化学"
    ];

    function getKanaRow(kana) {
        const first = kana.charAt(0);
        if (/[あ-お]/.test(first)) return "あ";
        if (/[か-こが-ご]/.test(first)) return "か";
        if (/[さ-そざ-ぞ]/.test(first)) return "さ";
        if (/[た-とだ-ど]/.test(first)) return "た";
        if (/[な-の]/.test(first)) return "な";
        if (/[は-ほば-ぼぱ-ぽ]/.test(first)) return "は";
        if (/[ま-も]/.test(first)) return "ま";
        if (/[や-よ]/.test(first)) return "や";
        if (/[ら-ろ]/.test(first)) return "ら";
        if (/[わ-ん]/.test(first)) return "わ";
        return "その他";
    }

    function updateMakerOptions(catSelect) {
        const row = catSelect.value;
        const makerSelect = catSelect.closest('.item-card').querySelector('.maker-select');
        makerSelect.innerHTML = '<option value="">選択してください</option>';
        if (row === "その他") { makerSelect.innerHTML = '<option value="備考に記入">備考に記入</option>'; return; }
        if (!row) { makerSelect.innerHTML = '<option value="">行を選んでください</option>'; return; }
        allMakers.filter(item => getKanaRow(item.split(':')[0]) === row).forEach(item => {
            const name = item.split(':')[1];
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            makerSelect.appendChild(opt);
        });
    }

    async function loadHistory(userId) {
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        try {
            const response = await fetch(`${gasUrl}?userId=${userId}`);
            const history = await response.json();
            if (history && history.length > 0) {
                historySection.style.display = 'block';
                historyList.innerHTML = history.map(h => `
                    <div class="history-item" onclick="applyHistory('${h.maker}', '${h.partNo}', '${h.quantity}')">
                        <span class="history-date">${h.date}</span><br>
                        <strong>${h.maker}</strong> / ${h.partNo} (数量: ${h.quantity})
                    </div>
                `).join('');
            } else { historySection.style.display = 'none'; }
        } catch (e) { console.error("History Error", e); }
    }

    function applyHistory(maker, partNo, quantity) {
        if (!confirm(`${maker} を追加しますか？`)) return;
        const container = document.getElementById('itemContainer');
        const cards = container.querySelectorAll('.item-card');
        let targetCard = (cards.length === 1 && !cards[0].querySelector('.partNo-input').value) ? cards[0] : null;
        if (!targetCard) { addNewItem(); const uCards = container.querySelectorAll('.item-card'); targetCard = uCards[uCards.length - 1]; }
        targetCard.querySelector('.category-select').value = "その他";
        targetCard.querySelector('.maker-select').innerHTML = `<option value="${maker}">${maker}</option>`;
        targetCard.querySelector('.partNo-input').value = partNo;
        targetCard.querySelector('.quantity-input').value = quantity;
    }

    function addNewItem() {
        const container = document.getElementById('itemContainer');
        const firstCard = container.querySelector('.item-card');
        const newCard = firstCard.cloneNode(true);
        newCard.querySelector('.item-header').innerHTML = '<span class="item-label">追加商品</span><button type="button" class="remove-btn" onclick="this.closest(\'.item-card\').remove()">削除</button>';
        newCard.querySelectorAll('input').forEach(i => i.value = (i.type === 'number' ? 1 : ''));
        newCard.querySelector('.maker-select').innerHTML = '<option value="">行を選んでください</option>';
        newCard.querySelector('.category-select').value = "";
        container.appendChild(newCard);
    }
// --- ここからが画像2枚送信の重要な修正部分 ---
    async function sendOrder() {
        const btn = document.getElementById('sendBtn');
        const storeName = document.getElementById('storeName').value;
        if (!storeName) { alert('店名を入れてください'); return; }

        const items = [];
        document.querySelectorAll('.item-card').forEach(card => {
            const m = card.querySelector('.maker-select').value;
            const p = card.querySelector('.partNo-input').value;
            const q = card.querySelector('.quantity-input').value;
            if (m) items.push({ maker: m, partNo: p, quantity: q });
        });
        if (items.length === 0) { alert('注文商品を入力してください'); return; }

        btn.disabled = true; 
        btn.innerText = "送信中..."; 
        document.getElementById('loadingMsg').style.display = 'block';

        // ファイル読み取り用補助関数
        const readFile = (id) => {
            const file = document.getElementById(id).files[0];
            return new Promise((resolve) => {
                if (!file) resolve(null);
                else {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, name: file.name });
                    reader.readAsDataURL(file);
                }
            });
        };

        // 2つのファイルを並列で読み込み
        const [img1, img2] = await Promise.all([readFile('imageFile1'), readFile('imageFile2')]);
        const images = [img1, img2].filter(i => i !== null); // 選択された画像だけを配列にする

        const orderData = {
            storeName: storeName,
            email: document.getElementById('email').value,
            items: items,
            comments: document.getElementById('comments').value,
            userId: currentUserProfile ? currentUserProfile.userId : "unknown",
            images: images // 配列として送信
        };

        try {
            await fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(orderData)
            });
            localStorage.setItem('storeName', storeName);
            localStorage.setItem('email', document.getElementById('email').value);
            alert('注文を送信しました！'); 
            liff.closeWindow();
        } catch (e) {
            alert('送信に失敗しました。');
            btn.disabled = false;
            btn.innerText = "注文を送信する";
            document.getElementById('loadingMsg').style.display = 'none';
        }
    }

    async function initLiff() {
        try {
            await liff.init({ liffId: "2008835052-zCjbE0pV" });
            if (!liff.isLoggedIn()) { liff.login(); } else {
                currentUserProfile = await liff.getProfile();
                document.getElementById('userInfo').textContent = "ユーザー: " + currentUserProfile.displayName;
                loadHistory(currentUserProfile.userId);
            }
        } catch (e) { document.getElementById('userInfo').textContent = "初期化失敗"; }
    }

    window.onload = function() {
        initLiff();
        if (localStorage.getItem('storeName')) document.getElementById('storeName').value = localStorage.getItem('storeName');
        if (localStorage.getItem('email')) document.getElementById('email').value = localStorage.getItem('email');
    };
</script>
</body>
</html>
