<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwXaNaJgO56x67XzCCUFa_vMkyz9mUb6J75Z0ADfTZyzRW8qrcfB8I8mf06mbicrvc/exec"; 
    let cart = [];
    let currentZip = ""; 

    liff.init({ liffId: "2008942151-HVIKLBVG" })
        .then(() => { console.log("LIFF Init OK"); })
        .catch((err) => { alert("LIFF初期化失敗: " + err); });

    function showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.footer-menu button').forEach(btn => btn.classList.remove('active-menu'));
        document.getElementById('nav-' + pageId).classList.add('active-menu');
    }

    async function fetchCustomerData(val) {
        if (!val) return;
        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "customerSearch", val: val })
            });
            const data = await res.json();
            if (data && data.customer) {
                document.getElementById("res-customer").innerText = data.customer;
                document.getElementById("res-address1").innerText = data.address1 || "";
                document.getElementById("res-address2").innerText = data.address2 || "";
                document.getElementById("res-tel").innerText = data.tel || "";
                document.getElementById("res-email").innerText = data.email || "";
                currentZip = data.zip || ""; 
                document.getElementById("cust-loading").style.display = "none";
                document.getElementById("cust-data").style.display = "block";
            } else {
                alert("顧客が見つかりません");
            }
        } catch (e) { alert("顧客検索エラー: " + e.message); }
    }

    async function searchProduct(code) {
        if (!code) return;
        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "productSearch", jan: String(code).trim() })
            });
            const data = await res.json();
            if (data && data.items && data.items.length > 0) {
                const product = data.items[0];
                cart.push({
                    jan: product.jan,
                    partNo: product.partNo,
                    name: product.name,
                    price: Number(product.price),
                    quantity: Number(product.lot || 1),
                    lot: Number(product.lot || 1),
                    stock: product.stock,
                    maker: product.maker 
                });
                updateCartUI();
                showPage('cart');
            } else {
                alert("商品マスタ登録なし");
            }
        } catch (e) { alert("商品検索エラー: " + e.message); }
    }

    async function sendOrder() {
        if (cart.length === 0) { alert("カートが空です"); return; }
        const customerName = document.getElementById("res-customer").innerText;
        if (!customerName) { alert("顧客情報を検索してください"); return; }
        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        try {
            const requestData = {
                customerName: customerName,
                zip: currentZip,
                address1: document.getElementById("res-address1").innerText,
                address2: document.getElementById("res-address2").innerText,
                tel: document.getElementById("res-tel").innerText,
                email: document.getElementById("res-email").innerText,
                comment: document.getElementById("order-comment").value,
                items: cart
            };
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "orderSubmit", data: requestData })
            });
            if (res.ok) {
                alert("注文を送信しました");
                cart = [];
                updateCartUI();
                showPage('home');
            }
        } catch (e) {
            alert("送信エラー: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    function handleCustomerManualSearch() {
        const val = document.getElementById('cust-manual-input').value.trim();
        if (val) fetchCustomerData(val);
    }
    
    function handleScan() {
        liff.scanCodeV2().then(res => { if (res.value) searchProduct(res.value); });
    }

    function handleManualSearch() {
        const val = document.getElementById('manual-id').value.trim();
        if (val) {
            searchProduct(val);
            document.getElementById('manual-id').value = "";
        }
    }

    function updateCartUI() {
        const list = document.getElementById('cart-list');
        if (cart.length === 0) { list.innerHTML = '<p style="text-align: center;">空です</p>'; return; }
        let total = 0;
        let html = cart.map((item, i) => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            return `
                <div class="item-card" style="position: relative;">
                    <b>${item.name}</b><br>
                    <small>メーカー: ${item.maker || "未設定"} / 品番: ${item.partNo}</small><br>
                    
                    <div style="background: #fff5f5; padding: 8px; border-radius: 5px; margin: 8px 0; border: 1px solid #ffcccc;">
                        <span style="color: #d9534f; font-weight: bold;">在庫状況: ${item.stock || "設定なし"}</span><br>
                        <button onclick="toggleStock('${item.partNo}', 'あり')" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:3px; font-size:12px; margin-top:5px; cursor:pointer;">販売中にする</button>
                        <button onclick="toggleStock('${item.partNo}', '完売')" style="background:#d9534f; color:white; border:none; padding:5px 10px; border-radius:3px; font-size:12px; margin-top:5px; margin-left:5px; cursor:pointer;">完売にする</button>
                    </div>

                    単価: ${item.price.toLocaleString()}円<br>
                    数量: <input type="number" value="${item.quantity}" onchange="updateQty(${i}, this.value)" style="width:60px; font-size:16px;">
                    
                    <button onclick="removeItem(${i})" style="position: absolute; top: 10px; right: 10px; color: #999; background: none; border: none; font-size: 1.2em;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>`;
        }).join('');
        html += `<div style="text-align:right; margin-top: 10px;"><b>合計: ${total.toLocaleString()}円</b></div>`;
        list.innerHTML = html;
    }

    function updateQty(i, q) { if (q > 0) { cart[i].quantity = parseInt(q); updateCartUI(); } }

    function removeItem(i) {
        if (confirm("削除しますか？")) {
            cart.splice(i, 1);
            updateCartUI();
        }
    }

    async function toggleStock(partNo, newStatus) {
        if (!confirm(`この商品の在庫状況を「${newStatus}」に変更しますか？`)) return;
        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "updateStock", partNo: partNo, status: newStatus })
            });
            const data = await res.json();
            if (data.success) {
                alert("在庫状況を更新しました。");
                const item = cart.find(i => i.partNo === partNo);
                if (item) item.stock = newStatus;
                updateCartUI();
            } else {
                alert("エラー: " + data.error);
            }
        } catch (e) {
            alert("通信エラー: " + e.message);
        }
    }

    async function handleCustomerScan() {
        try {
            const res = await liff.scanCodeV2();
            if (res.value) await fetchCustomerData(res.value);
        } catch (e) { alert("スキャン失敗"); }
    }
</script>
