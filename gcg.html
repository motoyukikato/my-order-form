<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ご注文アプリ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
        .item-card { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        /* 画像のスタイルを調整 */
        .item-img { width: 70px; height: 70px; object-fit: cover; margin-right: 15px; border-radius: 4px; background: #eee; }
        .item-info { flex-grow: 1; }
        .qty-input { width: 60px; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-submit { width: 100%; padding: 15px; background: #00b900; color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; margin-top: 20px; position: sticky; bottom: 10px; }
        h3 { background:#f0f0f0; padding:10px; margin-top:20px; border-left:5px solid #00b900; position: sticky; top: 0; z-index: 5; }
    </style>
</head>
<body>
    <div id="app">
        <h2 style="text-align: center;">商品一覧</h2>
        <div id="itemList">読み込み中...</div>
        <button class="btn-submit" onclick="submitOrder()">注文を確定する</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwLHot_VlrqiojTs0_FdwJmHO1PRhlQcXxtz84LAmFdNgvPGe2RgEGtmCMaFiT0z7N1Mg/exec";

// カテゴリー判定ロジック
function getCategory(id) {
    const frameItems = ["EDC-001-N", "EDC-002-N", "680-819-310", "680-824-310"];
    if (frameItems.includes(id)) return "フレーム";

    const sizaiItems = ["EDC-001-NG", "EDC-001-NA", "EDC-001-NB", "EDC-002-NG", "EDC-002-NA", "EDC-002-NB"];
    if (sizaiItems.includes(id)) return "資材";

    const glassItems = ["777-410-000", "777-431-000", "777-432-000"];
    if (glassItems.includes(id)) return "ガラスドーム";

    return "その他";
}

// ① 起動時に在庫データを取得（Googleドライブ画像対応版）
async function loadItems() {
    try {
        const res = await fetch(GAS_URL);
        const items = await res.json();
        const listDiv = document.getElementById('itemList');
        listDiv.innerHTML = "";

        const categories = {};
        items.forEach(item => {
            const cat = getCategory(item.id);
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(item);
        });

        for (const [catName, catItems] of Object.entries(categories)) {
            listDiv.innerHTML += `<h3>${catName}</h3>`;
            
            catItems.forEach(item => {
                let imgHtml = "";
                // --- 【決定版】URLからIDを抜き出すロジック ---
                if (item.imageJson) {
                    let fileId = "";
                    const rawValue = item.imageJson.toString().replace(/\s+/g, ""); // スペース除去
                    
                    if (rawValue.includes("drive.google.com")) {
                        // URL形式の場合： /d/ と /view の間を抜く
                        const match = rawValue.match(/\/d\/(.+?)\//);
                        fileId = match ? match[1] : "";
                    } else {
                        // すでにIDのみが入っている場合
                        fileId = rawValue;
                    }
                    
                    if (fileId) {
                        // Googleドライブのサムネイル機能を使って表示を高速化
                        const driveUrl = `https://drive.google.com/thumbnail?authuser=0&sz=w320&id=${fileId}`;
                        imgHtml = `<img src="${driveUrl}" class="item-img" onerror="this.src='https://placehold.jp/24/cccccc/ffffff/200x200.png?text=No%20Image'">`;
                    }
                }
                
                if (!imgHtml) {
                    imgHtml = `<div class="item-img" style="display:flex;align-items:center;justify-content:center;font-size:10px;color:#999;background:#eee;">No Image</div>`;
                }

                listDiv.innerHTML += `
                    <div class="item-card">
                        ${imgHtml}
                        <div class="item-info">
                            <div><strong>${item.name}</strong></div>
                            <div style="font-size:0.8em; color:gray;">${item.id}<br>在庫: ${item.stock}${item.unit}</div>
                        </div>
                        <input type="number" class="qty-input" 
                            data-id="${item.id}" 
                            data-name="${item.name}" 
                            data-unit="${item.unit}" 
                            data-stock="${item.stock}"
                            min="0" placeholder="0">
                    </div>`;
            });
        }
    } catch (e) {
        document.getElementById('itemList').innerHTML = "読み込みエラー: " + e.message;
    }
}
// ② 注文確定ボタンの処理（変更なし）
async function submitOrder() {
    const inputs = document.querySelectorAll('.qty-input');
    const colOrders = [];
    inputs.forEach(input => {
        const qty = parseInt(input.value);
        if (qty > 0) {
            colOrders.push({
                ItemName: input.dataset.id,
                品名: input.dataset.name,
                Quantity: qty,
                Unit: input.dataset.unit,
                CurrentStock: parseInt(input.dataset.stock)
            });
        }
    });

    if (colOrders.length === 0) {
        alert("数量を入力してください。");
        return;
    }

    if (!confirm("注文を確定してもよろしいですか？")) return;

    const btn = document.querySelector('.btn-submit');
    btn.disabled = true;
    btn.innerText = "送信中...";

    const payload = {
        colOrders: colOrders,
        mailBody: createCustomerMail(colOrders),
        orderBody_Customer: createSupplierMail(colOrders, "customer"),
        orderBody_Self: createSupplierMail(colOrders, "self")
    };

    try {
        const response = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status === "success") {
            alert("確定されました。ありがとうございます。");
            liff.closeWindow();
        }
    } catch (e) {
        alert("送信エラーが発生しました。");
        btn.disabled = false;
        btn.innerText = "注文を確定する";
    }
}

function createCustomerMail(orders) {
    let rows = orders.map(o => `<tr><td>${o.ItemName}</td><td>${o.品名}</td><td>${o.Quantity} ${o.Unit}</td><td>${o.CurrentStock - o.Quantity}</td></tr>`).join('');
    return `<div style='font-family:Meiryo;'><p>golden child garden 様</p><p>ご注文ありがとうございます。</p><table border='1' style='border-collapse:collapse;'><tr bgcolor='#eee'><th>品番</th><th>品名</th><th>数量</th><th>在庫残</th></tr>${rows}</table></div>`;
}

function createSupplierMail(orders, type) {
    let filtered;
    if (type === "customer") {
        const targets = ["EDC-001-N","EDC-001-NG","EDC-001-NA","EDC-001-NB","EDC-002-N","EDC-002-NG","EDC-002-NA","EDC-002-NB","680-824-310"];
        filtered = orders.filter(o => targets.includes(o.ItemName));
    } else {
        const thresholds = { "777-410-000": 24, "777-431-000": 24, "680-819-310": 15, "777-432-000": 12 };
        filtered = orders.filter(o => o.CurrentStock - o.Quantity < (thresholds[o.ItemName] || 0));
    }
    if (filtered.length === 0) return null;
    let rows = filtered.map(o => `<tr><td>${o.ItemName}</td><td>${o.Quantity} ${o.Unit}</td></tr>`).join('');
    return `<div style='font-family:Meiryo;'><h3>発注書 (${type === "customer" ? "顧客納品" : "自社納品"})</h3><table border='1' style='border-collapse:collapse;'><tr><th>商品名</th><th>数量</th></tr>${rows}</table></div>`;
}

        liff.init({ liffId: "2008942151-9x7S0H52" }).then(() => {
            loadItems();
        });
    </script>
</body>
</html>
