<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¦‹æœ¬å¸‚æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .item-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #send-btn { background-color: #28a745; color: white; border: none; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>è¦‹æœ¬å¸‚ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>
    
    <button onclick="handleScan()">ğŸ“¸ å•†å“ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    
    <hr> <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #ddd;">
        <p style="margin: 0 0 10px 0; font-weight: bold;">å“ç•ªï¼ˆå•†å“Noï¼‰ã§å…¥åŠ›ï¼š</p>
        <input type="text" id="manual-id" placeholder="ä¾‹: 40229" style="width: 60%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button onclick="handleManualSearch()" style="padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">è¿½åŠ </button>
    </div>

    <hr> <h3>æ³¨æ–‡ã‚«ãƒ¼ãƒˆ</h3>
    <div id="cart-list">
        </div>

    <button id="send-btn" onclick="sendOrder()">ğŸ›’ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>

    <script>
        // â˜… ã“ã“ã«ã€Œæ¤œç´¢ç”¨ã€ã¨ã€Œé€ä¿¡ç”¨ã€ã®URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹
        const SEARCH_URL = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e251147543764915b5e738754e6c8116/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TowxosK6T9X4qf8OE_FzC45ns9RLytXJgo3c8gOEi6Q";
        const ORDER_URL = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/07f9d1f370764796ac8a33bb06b2ab90/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2EIkThjCBuMWWQX8AuwTthobbzJ77KHfCCFnT-_UtqM";

        const cart = []; // ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸå•†å“ã‚’æºœã‚ã‚‹é…åˆ—

        async function handleScan() {
            try {
                const result = await liff.scanCodeV2();
                const code = result.value;
                if (!code) return;

                // Power Automateã§å•†å“æ¤œç´¢
                const res = await fetch(SEARCH_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ jan: code })
                });
                const data = await res.json();

                // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                cart.push({ jan: code, name: data.name, price: data.price });
                updateCartUI();

            } catch (err) { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            list.innerHTML = "";
            cart.forEach(item => {
                const div = document.createElement('div');
                div.className = "item-card";
                div.innerHTML = `<b>${item.name}</b><br>JAN: ${item.jan} / å˜ä¾¡: ${item.price}å††`;
                list.appendChild(div);
            });
        }

        async function sendOrder() {
            if (cart.length === 0) return alert("å•†å“ãŒã‚ã‚Šã¾ã›ã‚“");
            
            try {
                // Power Automateï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ•ãƒ­ãƒ¼ï¼‰ã¸ã€Œé…åˆ—ã€ã¨ã—ã¦é€ã‚‹
                const res = await fetch(ORDER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ items: cart }) // â˜…ã“ã‚ŒãŒã‚¨ãƒ©ãƒ¼ã‚’ç›´ã™éµã€ŒArrayã€ã§ã™
                });
                if (res.ok) alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            } catch (err) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }

        liff.init({ liffId: "2008942151-HVIKLBVG" });
        // å“ç•ªå…¥åŠ›ã§å•†å“ã‚’æ¢ã™é–¢æ•°
async function handleManualSearch() {
    const idField = document.getElementById('manual-id');
    const code = idField.value.trim();

    if (!code) {
        alert("å“ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    try {
        const res = await fetch(SEARCH_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jan: code })
        });
        
        const data = await res.json();

        if (data.name) {
            cart.push({ jan: code, name: data.name, price: data.price });
            updateCartUI(); // ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
            idField.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        } else {
            alert("è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å“ç•ªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    } catch (err) {
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
}
    </script>
</body>
</html>


