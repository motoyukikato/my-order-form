<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¦‹æœ¬å¸‚æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .item-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #send-btn { background-color: #28a745; color: white; border: none; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>è¦‹æœ¬å¸‚ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>
    <button onclick="handleScan()">ğŸ“¸ å•†å“ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    
    <div id="cart-list">
        </div>

    <button id="send-btn" onclick="sendOrder()">ğŸ›’ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>

    <script>
        // â˜… ã“ã“ã«ã€Œæ¤œç´¢ç”¨ã€ã¨ã€Œé€ä¿¡ç”¨ã€ã®URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹
        const SEARCH_URL = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e251147543764915b5e738754e6c8116/triggers/manual/paths/invoke?api-version=1";
        const ORDER_URL = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/07f9d1f370764796ac8a33bb06b2ab90/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2EIkThjCBuMWWQX8AuwTthobbzJ77KHfCCFnT-_UtqM";

        const cart = []; // ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸå•†å“ã‚’æºœã‚ã‚‹é…åˆ—

        async function handleScan() {
            try {
                const result = await liff.scanCodeV2();
                const code = result.value;
                if (!code) return;

                // Power Automateã§å•†å“æ¤œç´¢
                const res = await fetch(SEARCH_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ jan: code })
                });
                const data = await res.json();

                // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                cart.push({ jan: code, name: data.name, price: data.price });
                updateCartUI();

            } catch (err) { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            list.innerHTML = "";
            cart.forEach(item => {
                const div = document.createElement('div');
                div.className = "item-card";
                div.innerHTML = `<b>${item.name}</b><br>JAN: ${item.jan} / å˜ä¾¡: ${item.price}å††`;
                list.appendChild(div);
            });
        }

        async function sendOrder() {
            if (cart.length === 0) return alert("å•†å“ãŒã‚ã‚Šã¾ã›ã‚“");
            
            try {
                // Power Automateï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ•ãƒ­ãƒ¼ï¼‰ã¸ã€Œé…åˆ—ã€ã¨ã—ã¦é€ã‚‹
                const res = await fetch(ORDER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ items: cart }) // â˜…ã“ã‚ŒãŒã‚¨ãƒ©ãƒ¼ã‚’ç›´ã™éµã€ŒArrayã€ã§ã™
                });
                if (res.ok) alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            } catch (err) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }

        liff.init({ liffId: "2008942151-HVIKLBVG" });
    </script>
</body>
</html>
