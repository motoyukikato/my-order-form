<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE受注システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #interactive.viewport { width: 100%; height: 300px; position: relative; overflow: hidden; }
        #interactive.viewport > canvas, #interactive.viewport > video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .order-item { border-bottom: 1px solid #ccc; padding: 10px 0; }
        button { padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>LINE受注システム</h2>

    <div id="interactive" class="viewport"></div>
    <p>ステータス: <span id="status">読み取り停止中</span></p>
    <button onclick="startScanner()">スキャン開始</button>

    <hr>

    <div id="customer-info">
        <h3>顧客情報</h3>
        <p>社名: <span id="company-name">未取得</span></p>
    </div>

    <div id="cart-area">
        <h3>注文商品一覧</h3>
        <div id="cart-list"></div>
        <button onclick="sendOrder()" style="margin-top:20px; background:#007bff;">注文を確定してメール送信</button>
    </div>

    <script>
        const API_URL = "あなたのPower AutomateのURL"; // ★ここにURLを貼り付け
        let cart = [];

        function startScanner() {
            document.getElementById('status').innerText = "読み取り中...";
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive') },
                decoder: { readers: ["ean_reader", "code_128_reader", "qr_reader"] }
            }, function(err) {
                if (err) { console.log(err); return; }
                Quagga.start();
            });
        }

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            document.getElementById('status').innerText = "読み取り成功: " + code;
            
            // 無限追加の仕組み：読み取ったコードをカートに追加
            addItemToCart(code);
            Quagga.stop(); // 一旦停止
        });

        function addItemToCart(jan) {
            // 本来はここでSharePointから商品名を取得するが、まずはJANと数量1を追加
            cart.push({ jan: jan, quantity: 1 });
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const list = document.getElementById('cart-list');
            list.innerHTML = cart.map((item, index) => `
                <div class="order-item">
                    JAN: ${item.jan} | 数量: <input type="number" value="${item.quantity}" onchange="cart[${index}].quantity=this.value">
                </div>
            `).join('');
        }

        async function sendOrder() {
            // Power Automateへ送信
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items: cart })
            });
            if (response.ok) alert("受注完了！メールを送信しました。");
        }
    </script>
</body>
</html>
