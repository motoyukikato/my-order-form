<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>名古屋花き商事本部受注アプリ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { font-size: 20px; text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, textarea, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .item-card { background: #fdfdfd; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .item-name-display { font-size: 13px; color: #28a745; margin-top: 5px; min-height: 1em; font-weight: bold; }
        .remove-btn { background: #ff4d4d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; float: right; font-size: 12px; }
        .add-btn { background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 20px; }
        #sendBtn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .loading { display: none; text-align: center; margin-top: 10px; font-weight: bold; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>名古屋花き商事本部 注文フォーム</h2>
    <div id="userInfo" style="font-size:12px; text-align:right; color:#28a745; margin-bottom:10px;"></div>

    <div class="input-group">
        <label>店名</label>
        <input type="text" id="storeName" placeholder="必須入力">
    </div>

    <div class="input-group">
        <label>メールアドレス</label>
        <input type="email" id="email" placeholder="控え送信先">
    </div>

    <hr>
    <h3>注文内容</h3>
    
    <div id="itemContainer">
        <div class="item-card">
            <button type="button" class="remove-btn" onclick="if(document.querySelectorAll('.item-card').length>1) this.closest('.item-card').remove()">削除</button>
            <div class="input-group">
                <label>JANコード / 品番</label>
                <input type="text" class="partNo-input" placeholder="入力後に自動検索" onchange="fetchItemName(this)">
                <div class="item-name-display"></div>
            </div>
            <div class="input-group">
                <label>数量</label>
                <input type="number" class="quantity-input" value="1" min="1">
            </div>
        </div>
    </div>

    <button type="button" class="add-btn" onclick="addNewItem()">＋ 商品を追加する</button>

    <div class="input-group">
        <label>備考</label>
        <textarea id="comments" rows="3"></textarea>
    </div>

    <button id="sendBtn" onclick="sendOrder()">注文を送信する</button>
    <div id="loadingMsg" class="loading">処理中...</div>
</div>

<script>
    // ★Power AutomateのURLをここに貼り付け
    const flowUrl = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2a103696f19b42f685e940c3f0bdab05/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TuEWCx-Z2Grf6fep1ZQtUXF762w8NZbPJUAS8XxIod4";

    async function initLiff() {
        await liff.init({ liffId: "2008835052-zCjbE0pV" });
        if (!liff.isLoggedIn()) { liff.login(); }
        const profile = await liff.getProfile();
        document.getElementById('userInfo').textContent = "ユーザー: " + profile.displayName;
    }

    window.onload = () => {
        initLiff();
        document.getElementById('storeName').value = localStorage.getItem('storeName') || "";
        document.getElementById('email').value = localStorage.getItem('email') || "";
    };

    // JANコードから商品名を検索する関数
    async function fetchItemName(input) {
        const jan = input.value;
        const display = input.parentElement.querySelector('.item-name-display');
        if (!jan) { display.textContent = ""; return; }
        
        display.textContent = "検索中...";
        try {
            const res = await fetch(flowUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: "lookup", jan: jan })
            });
            const data = await res.json();
            display.textContent = data.itemName ? "商品名: " + data.itemName : "⚠️商品が見つかりません";
            display.style.color = data.itemName ? "#28a745" : "#ff4d4d";
        } catch (e) {
            display.textContent = "検索エラー";
        }
    }

    function addNewItem() {
        const container = document.getElementById('itemContainer');
        const clone = container.firstElementChild.cloneNode(true);
        clone.querySelector('.partNo-input').value = "";
        clone.querySelector('.item-name-display').textContent = "";
        clone.querySelector('.quantity-input').value = 1;
        container.appendChild(clone);
    }

    async function sendOrder() {
        const storeName = document.getElementById('storeName').value;
        if (!storeName) { alert("店名を入力してください"); return; }

        const items = Array.from(document.querySelectorAll('.item-card')).map(card => ({
            partNo: card.querySelector('.partNo-input').value,
            quantity: card.querySelector('.quantity-input').value
        })).filter(i => i.partNo);

        if (items.length === 0) { alert("商品を入力してください"); return; }

        document.getElementById('sendBtn').disabled = true;
        document.getElementById('loadingMsg').style.display = 'block';

        try {
            const res = await fetch(flowUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    storeName,
                    email: document.getElementById('email').value,
                    items,
                    comments: document.getElementById('comments').value
                })
            });
            if (res.ok) {
                localStorage.setItem('storeName', storeName);
                localStorage.setItem('email', document.getElementById('email').value);
                alert("注文を送信しました！");
                liff.closeWindow();
            }
        } catch (e) {
            alert("送信失敗");
        } finally {
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('loadingMsg').style.display = 'none';
        }
    }
</script>
</body>
</html>
