<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—æ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        input[type="number"] { width: 50px; padding: 5px; }
        button { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn-scan { background: #00b900; color: white; }
        .btn-send { background: #007bff; color: white; }
        #status { font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

    <div class="card">
        <h3>ğŸ‘¤ é¡§å®¢æƒ…å ±</h3>
        <p id="cust-name">æœªå–å¾—ï¼ˆQRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ï¼‰</p>
    </div>

    <div class="card">
        <h3>ğŸ›’ æ³¨æ–‡å•†å“ä¸€è¦§</h3>
        <div id="cart-list">
            </div>
        <button class="btn-scan" onclick="handleScan()">ğŸ“¸ å•†å“ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    </div>

    <button class="btn-send" onclick="sendOrder()">âœ… æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    <p id="status">LIFFåˆæœŸåŒ–ä¸­...</p>

    <script>
        const LIFF_ID = "2008942151-HVIKLBVG"; 
        const FLOW_URL = "https://default9b258ec3f0904041bdcf3f8e9c128b.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/07f9d1f370764796ac8a33bb06b2ab90/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2EIkThjCBuMWWQX8AuwTthobbzJ77KHfCCFnT-_UtqM";
        let orderList = [];

        // 1. LIFFã®åˆæœŸåŒ–
        liff.init({ liffId: LIFF_ID }).then(() => {
            document.getElementById('status').innerText = "ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†";
        }).catch(err => {
            document.getElementById('status').innerText = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err;
        });

        // 2. ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
        async function handleScan() {
            try {
                const result = await liff.scanCodeV2();
                const code = result.value;
                if (!code) return;

                // Power Automateã¸ãƒ‡ãƒ¼ã‚¿ã‚’å•ã„åˆã‚ã›ã‚‹
                document.getElementById('status').innerText = "å•†å“æ¤œç´¢ä¸­...";
                const res = await fetch(FLOW_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ jan: code })
                });
                
                const item = await res.json(); // ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å“åã¨å˜ä¾¡ãŒè¿”ã£ã¦ãã‚‹æƒ³å®š
                addItem(item.name, item.price, code);
                document.getElementById('status').innerText = "è¿½åŠ å®Œäº†: " + item.name;

            } catch (err) {
                alert("ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
            }
        }

        // 3. ç”»é¢ã«å•†å“è¡Œã‚’ã€Œç„¡é™è¿½åŠ ã€
        function addItem(name, price, jan) {
            const list = document.getElementById('cart-list');
            const row = document.createElement('div');
            row.className = 'order-item';
            row.innerHTML = `
                <div>
                    <strong>${name}</strong><br>
                    <small>${price}å†† (JAN:${jan})</small>
                </div>
                <input type="number" class="item-qty" value="1" data-jan="${jan}" data-name="${name}" data-price="${price}">
            `;
            list.appendChild(row);
            orderList.push({ jan, name, price });
        }

        // 4. æ³¨æ–‡é€ä¿¡
        async function sendOrder() {
            // ã“ã“ã§å†åº¦Power Automateã‚’å©ã„ã¦SharePointã«ä¿å­˜ï¼†ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            alert("æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆã“ã®å…ˆã®ãƒ•ãƒ­ãƒ¼ã¯åˆ¥é€”æ§‹ç¯‰ãŒå¿…è¦ã§ã™ï¼‰");
        }
    </script>
</body>
</html>
